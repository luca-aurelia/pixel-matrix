<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme-color" content="#000000">
  <title>Pixel Matrix Convolution Demo</title>
  <style>
  body {
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100vw;
    height: 100vh;
  }
  </style>
</head>
<body>
  <script type="module">
  import PixelMatrix from '../index.js'
  import ConvolutionFilter from './ConvolutionFilter.js'

  const TWO_PI = Math.PI * 2
  const sine = (amplitude, frequency, phase) => t => amplitude * Math.sin(TWO_PI * frequency * t + phase)
  const randomSign = () => {
    if (Math.random() > 0.5) {
      return 1
    } else {
      return -1
    }
  }
  const randomWalk = x => {
    let newX = x + (randomSign() * 0.05)
    if (newX < -1) newX = -1
    if (newX > 1) newX = 1
    return newX
  }

  const WIDTH = 300
  const HEIGHT = 300

  // Create canvas
  var canvas = document.createElement('canvas')
  canvas.width = WIDTH
  canvas.height = HEIGHT
  // canvas.style.imageRendering = 'pixelated'
  canvas.style.width = WIDTH * 1 + 'px'
  canvas.style.height = HEIGHT * 1 + 'px'
  canvas.style.margin = 'auto'
  const context = canvas.getContext('2d')
  document.body.appendChild(canvas)

  // Load image from Unsplash
  const image = new Image()
  image.crossOrigin = 'anonymous'
  image.onload = () => {
    context.drawImage(image, 0, 0, WIDTH, HEIGHT)
    const matrix = PixelMatrix.fromCanvas(canvas)
    // const greyscale = matrix.map((point, pixel) => {
    //   const average = (pixel.red + pixel.green + pixel.blue) / 3
    //   return {
    //     red: average,
    //     green: average,
    //     blue: average,
    //     alpha: pixel.alpha
    //   }
    // })
    // greyscale.putPixels(canvas)
    const convolve = weights => {
      const filter = new ConvolutionFilter(weights)
      const filtered = matrix.map(filter.mapper)
      filtered.putPixels(canvas)
    }
    // eslint-disable
    let weights = [
      [0, 1, 2],
      [3, 4, 5],
      [6, 7, 8]
    ]
    let weightFunctions = weights.map((row, rowIndex) =>
      row.map((weight, columnIndex) =>
        sine(0.5, rowIndex, columnIndex)
      )
    )

    let t = 0
    const randomConvolution = () => {
      window.requestAnimationFrame(randomConvolution)
      // const weights = [
      //   [Math.random() * 2 - 1, Math.random() * 2 - 1, Math.random() * 2 - 1],
      //   [Math.random() * 2 - 1, Math.random() * 2 - 1, Math.random() * 2 - 1],
      //   [Math.random() * 2 - 1, Math.random() * 2 - 1, Math.random() * 2 - 1]
      // ]
      weights = weightFunctions.map((row, rowIndex) =>
        row.map((sine, columnIndex) =>
          sine(t)
        )
      )
      convolve(weights)
      t += 0.01
    }
    window.requestAnimationFrame(randomConvolution)
  }
  image.src = `/demos/photo.jpg`
  </script>
</body>
</html>
